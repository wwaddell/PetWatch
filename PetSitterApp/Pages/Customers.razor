@page "/customers"
@inject LocalDbService LocalDb
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject SyncService SyncService
@using PetSitterApp.Models

<MudStack Row="true" Class="mb-4">
    <MudText Typo="Typo.h5">Customers</MudText>
    <MudSpacer />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddCustomerDialog">Add Customer</MudButton>
</MudStack>

<MudTextField @bind-Value="_searchString" Placeholder="Search by name" Adornment="Adornment.Start" Immediate="true" AdornmentIcon="@Icons.Material.Filled.Search" Class="mb-4" />

<MudDataGrid Items="@CustomerList" Filterable="true" Sortable="true" RowsPerPage="10" FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive" QuickFilter="@_quickFilter">
    <Columns>
        <PropertyColumn Property="x => x.FullName" Title="Name" />
        <TemplateColumn Title="Email">
            <CellTemplate>
                <MudLink Href="@($"mailto:{context.Item.Email}")">@context.Item.Email</MudLink>
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Phone">
            <CellTemplate>
                <MudLink OnClick="@(() => OpenContactDialog(context.Item))" Underline="Underline.Always">@context.Item.PhoneNumber</MudLink>
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Balance">
            <CellTemplate>
                @GetCustomerBalance(context.Item).ToString("C")
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Notes">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Note"
                               Color="Color.Primary"
                               Disabled="@(!HasNotes(context.Item))"
                               OnClick="@(() => OpenNotesDialog(context.Item))" />
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Actions">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditCustomerDialog(context.Item))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteCustomer(context.Item))" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="Customer" />
    </PagerContent>
</MudDataGrid>

@code {
    private List<Customer> CustomerList = new();
    private List<Appointment> AppointmentList = new();
    private List<Payment> PaymentList = new();
    private List<Pet> AllPets = new();
    private Dictionary<Guid, decimal> _customerBalances = new();
    private string _searchString = string.Empty;

    private Func<Customer, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.FullName.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        CustomerList = (await LocalDb.GetCustomers()).Where(c => !c.IsDeleted).ToList();
        AppointmentList = await LocalDb.GetAppointments();
        PaymentList = await LocalDb.GetPayments();
        AllPets = await LocalDb.GetPets();
        CalculateBalances();
        StateHasChanged();
    }

    private void CalculateBalances()
    {
        _customerBalances.Clear();

        // 1. Calculate Expected & Build Map
        var expectedAmounts = new Dictionary<Guid, decimal>();
        var apptToCustomer = new Dictionary<Guid, Guid>();

        foreach (var appt in AppointmentList)
        {
            apptToCustomer[appt.Id] = appt.CustomerId;

            if (!expectedAmounts.ContainsKey(appt.CustomerId))
                expectedAmounts[appt.CustomerId] = 0;
            expectedAmounts[appt.CustomerId] += appt.ExpectedAmount;
        }

        // 2. Calculate Paid
        var paidAmounts = new Dictionary<Guid, decimal>();
        foreach (var payment in PaymentList)
        {
            if (apptToCustomer.TryGetValue(payment.AppointmentId, out var custId))
            {
                if (!paidAmounts.ContainsKey(custId))
                    paidAmounts[custId] = 0;
                paidAmounts[custId] += payment.Amount;
            }
        }

        // 3. Final Balance
        foreach (var customer in CustomerList)
        {
            decimal expected = expectedAmounts.TryGetValue(customer.Id, out var e) ? e : 0;
            decimal paid = paidAmounts.TryGetValue(customer.Id, out var p) ? p : 0;
            _customerBalances[customer.Id] = expected - paid;
        }
    }

    private bool HasNotes(Customer customer)
    {
        if (!string.IsNullOrWhiteSpace(customer.Notes)) return true;
        return AllPets.Any(p => p.CustomerId == customer.Id && !string.IsNullOrWhiteSpace(p.Notes));
    }

    private void OpenNotesDialog(Customer customer)
    {
        var pets = AllPets.Where(p => p.CustomerId == customer.Id && !string.IsNullOrWhiteSpace(p.Notes)).ToList();
        var parameters = new DialogParameters { ["Customer"] = customer, ["Pets"] = pets };
        DialogService.Show<NotesDialog>("Notes", parameters);
    }

    private void OpenContactDialog(Customer customer)
    {
        var pets = AllPets.Where(p => p.CustomerId == customer.Id).ToList();
        var parameters = new DialogParameters { ["Customer"] = customer, ["Pets"] = pets };
        DialogService.Show<CustomerContactDialog>(customer.FullName, parameters);
    }

    private decimal GetCustomerBalance(Customer customer)
    {
        return _customerBalances.GetValueOrDefault(customer.Id);
    }

    private async Task OpenAddCustomerDialog()
    {
        var parameters = new DialogParameters { ["Customer"] = new Customer() };
        var dialog = DialogService.Show<CustomerDialog>("Add Customer", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            _ = Task.Run(async () => { await Task.Delay(1000); await SyncService.TryAutoSync(); });
        }
    }

    private async Task OpenEditCustomerDialog(Customer customer)
    {
        var parameters = new DialogParameters { ["Customer"] = customer };
        var dialog = DialogService.Show<CustomerDialog>("Edit Customer", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            _ = Task.Run(async () => { await Task.Delay(1000); await SyncService.TryAutoSync(); });
        }
    }

    private async Task DeleteCustomer(Customer customer)
    {
        // Check for existing appointments
        var hasAppointments = AppointmentList.Any(a => a.CustomerId == customer.Id && !a.IsDeleted);
        if (hasAppointments)
        {
            Snackbar.Add("Cannot delete customer with existing appointments.", Severity.Error);
            return;
        }

        bool? result = await DialogService.ShowMessageBox(
            "Delete Customer",
            "Are you sure you want to delete this customer?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            customer.IsDeleted = true;
            customer.UpdatedAt = DateTime.UtcNow;
            customer.SyncState = SyncState.PendingUpdate;
            await LocalDb.SaveCustomer(customer);
            await LoadData();
            _ = Task.Run(async () => { await Task.Delay(1000); await SyncService.TryAutoSync(); });
        }
    }
}
