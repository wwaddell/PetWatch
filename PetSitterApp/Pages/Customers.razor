@page "/customers"
@inject LocalDbService LocalDb
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject SyncService SyncService
@using PetSitterApp.Models

<MudStack Row="true" Class="mb-4">
    <MudText Typo="Typo.h5">Customers</MudText>
    <MudSpacer />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddCustomerDialog">Add Customer</MudButton>
</MudStack>

<MudDataGrid Items="@CustomerList" Filterable="true" Sortable="true" RowsPerPage="10">
    <Columns>
        <PropertyColumn Property="x => x.FullName" Title="Name" />
        <TemplateColumn Title="Email">
            <CellTemplate>
                <MudLink Href="@($"mailto:{context.Item.Email}")">@context.Item.Email</MudLink>
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Phone">
            <CellTemplate>
                <MudLink OnClick="@(() => OpenContactDialog(context.Item))" Underline="Underline.Always">@context.Item.PhoneNumber</MudLink>
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Balance">
            <CellTemplate>
                @GetCustomerBalance(context.Item).ToString("C")
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Notes">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Note"
                               Color="Color.Primary"
                               Disabled="@(!HasNotes(context.Item))"
                               OnClick="@(() => OpenNotesDialog(context.Item))" />
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Actions">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditCustomerDialog(context.Item))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteCustomer(context.Item))" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="Customer" />
    </PagerContent>
</MudDataGrid>

@code {
    private List<Customer> CustomerList = new();
    private List<Appointment> AppointmentList = new();
    private List<Payment> PaymentList = new();
    private List<Pet> AllPets = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        CustomerList = await LocalDb.GetCustomers();
        AppointmentList = await LocalDb.GetAppointments();
        PaymentList = await LocalDb.GetPayments();
        AllPets = await LocalDb.GetPets();
        StateHasChanged();
    }

    private bool HasNotes(Customer customer)
    {
        if (!string.IsNullOrWhiteSpace(customer.Notes)) return true;
        return AllPets.Any(p => p.CustomerId == customer.Id && !string.IsNullOrWhiteSpace(p.Notes));
    }

    private void OpenNotesDialog(Customer customer)
    {
        var pets = AllPets.Where(p => p.CustomerId == customer.Id && !string.IsNullOrWhiteSpace(p.Notes)).ToList();
        var parameters = new DialogParameters { ["Customer"] = customer, ["Pets"] = pets };
        DialogService.Show<NotesDialog>("Notes", parameters);
    }

    private void OpenContactDialog(Customer customer)
    {
        var parameters = new DialogParameters { ["Customer"] = customer };
        DialogService.Show<CustomerContactDialog>("Contact", parameters);
    }

    private decimal GetCustomerBalance(Customer customer)
    {
        var custAppts = AppointmentList.Where(a => a.CustomerId == customer.Id);
        decimal totalExpected = custAppts.Sum(a => a.ExpectedAmount);

        var custApptIds = custAppts.Select(a => a.Id).ToHashSet();
        decimal totalPaid = PaymentList.Where(p => custApptIds.Contains(p.AppointmentId)).Sum(p => p.Amount);

        return totalExpected - totalPaid;
    }

    private async Task OpenAddCustomerDialog()
    {
        var parameters = new DialogParameters { ["Customer"] = new Customer() };
        var dialog = DialogService.Show<CustomerDialog>("Add Customer", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            _ = SyncService.TryAutoSync();
        }
    }

    private async Task OpenEditCustomerDialog(Customer customer)
    {
        var parameters = new DialogParameters { ["Customer"] = customer };
        var dialog = DialogService.Show<CustomerDialog>("Edit Customer", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            _ = SyncService.TryAutoSync();
        }
    }

    private async Task DeleteCustomer(Customer customer)
    {
        // Check for existing appointments
        var hasAppointments = AppointmentList.Any(a => a.CustomerId == customer.Id);
        if (hasAppointments)
        {
            Snackbar.Add("Cannot delete customer with existing appointments.", Severity.Error);
            return;
        }

        bool? result = await DialogService.ShowMessageBox(
            "Delete Customer",
            "Are you sure you want to delete this customer?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            await LocalDb.DeleteCustomer(customer.Id);
            await LoadData();
            _ = SyncService.TryAutoSync();
        }
    }
}
