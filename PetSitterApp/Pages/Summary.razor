@page "/summary"
@using PetSitterApp.Models
@using PetSitterApp.Services
@using System.Globalization
@inject LocalDbService LocalDbService

<style>
    .mud-chart-bar {
        stroke-width: 40px !important;
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Financial Summary</MudText>

    <MudGrid Class="mb-2">
        <MudItem xs="6" sm="4" md="3">
            <MudDatePicker Label="Start Date" Date="_startDate" DateChanged="OnStartDateChanged" Editable="false" DateFormat="yyyy-MM-dd" PickerVariant="PickerVariant.Dialog" />
        </MudItem>
        <MudItem xs="6" sm="4" md="3">
            <MudDatePicker @ref="_endDatePicker" Label="End Date" Date="_endDate" DateChanged="OnEndDateChanged" Editable="false" DateFormat="yyyy-MM-dd" PickerVariant="PickerVariant.Dialog" MinDate="_startDate" />
        </MudItem>
        <MudItem xs="12" sm="4" md="2" Class="d-flex align-center">
             <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadData">Apply Filter</MudButton>
        </MudItem>
        <MudItem xs="12">
            <MudButtonGroup Variant="Variant.Outlined" OverrideStyles="false">
                <MudButton OnClick="SetThisYear">This Year</MudButton>
                <MudButton OnClick="SetLastYear">Last Year</MudButton>
                <MudButton OnClick="SetLast3Months">Last 3 Months</MudButton>
            </MudButtonGroup>
        </MudItem>
    </MudGrid>

    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudStack Row="true" Justify="Justify.Center" Spacing="4" Class="mb-0">
                    <MudText Typo="Typo.subtitle1">Expected: <b>@_totalExpected.ToString("C")</b></MudText>
                    <MudText Typo="Typo.subtitle1">Paid: <b style="color: var(--mud-palette-success);">@_totalPaid.ToString("C")</b></MudText>
                </MudStack>
                <MudChart ChartType="ChartType.Bar" ChartSeries="@_series" XAxisLabels="@_xAxisLabels" Width="100%" Height="350px" />
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private DateTime? _startDate = new DateTime(DateTime.Now.Year, 1, 1);
    private DateTime? _endDate = new DateTime(DateTime.Now.Year, 12, 31);
    private List<ChartSeries> _series = new();
    private string[] _xAxisLabels = Array.Empty<string>();
    private bool _loading = false;
    private double _totalExpected = 0;
    private double _totalPaid = 0;
    private MudDatePicker _endDatePicker;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var appointments = await LocalDbService.GetAppointments();
            var payments = await LocalDbService.GetPayments();

            ProcessData(appointments, payments);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OnStartDateChanged(DateTime? date)
    {
        _startDate = date;
        if (_startDate.HasValue)
        {
            var targetDate = _startDate.Value.AddMonths(3);
            var daysInMonth = DateTime.DaysInMonth(targetDate.Year, targetDate.Month);
            _endDate = new DateTime(targetDate.Year, targetDate.Month, daysInMonth);

            if (_endDatePicker != null)
            {
                _endDatePicker.PickerMonth = _endDate.Value;
            }
        }
    }

    private void OnEndDateChanged(DateTime? date)
    {
        _endDate = date;
    }

    private async Task SetThisYear()
    {
        _startDate = new DateTime(DateTime.Now.Year, 1, 1);
        _endDate = new DateTime(DateTime.Now.Year, 12, 31);
        await LoadData();
    }

    private async Task SetLastYear()
    {
        var lastYear = DateTime.Now.Year - 1;
        _startDate = new DateTime(lastYear, 1, 1);
        _endDate = new DateTime(lastYear, 12, 31);
        await LoadData();
    }

    private async Task SetLast3Months()
    {
        _endDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).AddMonths(1).AddDays(-1);
        _startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).AddMonths(-2);
        await LoadData();
    }

    private void ProcessData(List<Appointment> appointments, List<Payment> payments)
    {
        if (_startDate == null || _endDate == null) return;

        var start = _startDate.Value;
        // Ensure we cover the entire end day
        var end = _endDate.Value.Date.AddDays(1).AddTicks(-1);

        var labels = new List<string>();
        var expectedData = new List<double>();
        var paidData = new List<double>();

        var current = new DateTime(start.Year, start.Month, 1);
        var endMonth = new DateTime(end.Year, end.Month, 1);

        while (current <= endMonth)
        {
            var nextMonth = current.AddMonths(1);

            // Label
            if (start.Year != end.Year)
            {
                labels.Add(current.ToString("MMM yyyy"));
            }
            else
            {
                labels.Add(current.ToString("MMM"));
            }

            // Expected
            var monthExpected = appointments
                .Where(a => !a.IsDeleted && a.Start.HasValue
                            && a.Start.Value >= current && a.Start.Value < nextMonth
                            && a.Start.Value >= start && a.Start.Value <= end)
                .Sum(a => (double)a.ExpectedAmount);

            expectedData.Add(monthExpected);

            // Paid
            var monthPaid = payments
                .Where(p => !p.IsDeleted
                            && p.PaymentDate >= current && p.PaymentDate < nextMonth
                            && p.PaymentDate >= start && p.PaymentDate <= end
                            && !string.Equals(p.Method, "Write off", StringComparison.OrdinalIgnoreCase))
                .Sum(p => (double)p.Amount);

            paidData.Add(monthPaid);

            current = nextMonth;
        }

        _totalExpected = expectedData.Sum();
        _totalPaid = paidData.Sum();

        _xAxisLabels = labels.ToArray();
        _series = new List<ChartSeries>
        {
            new ChartSeries { Name = "Expected", Data = expectedData.ToArray() },
            new ChartSeries { Name = "Paid", Data = paidData.ToArray() }
        };
    }
}
