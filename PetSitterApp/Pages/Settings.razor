@page "/settings"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject SyncService SyncService

<MudText Typo="Typo.h5" Class="mb-4">Settings</MudText>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h6">Authentication</MudText>
    <AuthorizeView>
        <Authorized>
            <MudText>Hello, @context.User.Identity?.Name!</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="BeginSignOut">Log out</MudButton>
        </Authorized>
        <NotAuthorized>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="BeginSignIn">Log in with Google</MudButton>
        </NotAuthorized>
    </AuthorizeView>
</MudPaper>

<MudPaper Class="pa-4 mt-4">
    <MudText Typo="Typo.h6">Synchronization</MudText>
    <MudText Class="mb-2">Sync your data with Google Sheets and Calendar.</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SyncData" Disabled="@_isSyncing">
        @if (_isSyncing)
        {
            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
            <MudText Class="ms-2">Syncing...</MudText>
        }
        else
        {
            <MudText>Sync Now</MudText>
        }
    </MudButton>
</MudPaper>

@code {
    private bool _isSyncing = false;

    private void BeginSignIn()
    {
        Navigation.NavigateTo("authentication/login");
    }

    private void BeginSignOut(MouseEventArgs args)
    {
        Navigation.NavigateToLogout("authentication/logout");
    }

    private async Task SyncData()
    {
        _isSyncing = true;
        try
        {
            await SyncService.SyncData();
            // Show success message
        }
        catch (Exception ex)
        {
            // Show error
            Console.WriteLine(ex);
        }
        finally
        {
            _isSyncing = false;
        }
    }
}
