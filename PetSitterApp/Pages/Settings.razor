@page "/settings"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using PetSitterApp.Models
@inject NavigationManager Navigation
@inject SyncService SyncService
@inject LocalDbService LocalDb

<MudText Typo="Typo.h5" Class="mb-4">Settings</MudText>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h6">Authentication</MudText>
    <AuthorizeView>
        <Authorized>
            <MudText>Hello, @context.User.Identity?.Name!</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="BeginSignOut">Log out</MudButton>
        </Authorized>
        <NotAuthorized>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="BeginSignIn">Log in with Google</MudButton>
        </NotAuthorized>
    </AuthorizeView>
</MudPaper>

<MudPaper Class="pa-4 mt-4">
    <MudText Typo="Typo.h6">Services</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Tertiary" Href="/services">Manage Services</MudButton>
</MudPaper>

<MudPaper Class="pa-4 mt-4">
    <MudText Typo="Typo.h6">Synchronization</MudText>
    <MudText Class="mb-2">Sync your data with Google Sheets and Calendar.</MudText>

    <MudText Class="mb-2">Pending Records: @_pendingCount</MudText>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SyncData" Disabled="@_isSyncing">
        @if (_isSyncing)
        {
            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
            <MudText Class="ms-2">Syncing...</MudText>
        }
        else
        {
            <MudText>Sync Now</MudText>
        }
    </MudButton>

    @if (_errors.Any())
    {
        <MudAlert Severity="Severity.Error" Class="mt-2">
            @foreach(var err in _errors)
            {
                <MudText>@err</MudText>
            }
        </MudAlert>
    }
</MudPaper>

<MudText Typo="Typo.caption" Class="mt-4 d-block text-center">Version: @AppInfo.Version</MudText>

@code {
    private bool _isSyncing = false;
    private int _pendingCount = 0;
    private List<string> _errors = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadPendingCount();
    }

    private async Task LoadPendingCount()
    {
        try
        {
            var c = await LocalDb.GetCustomers();
            var p = await LocalDb.GetPets();
            var a = await LocalDb.GetAppointments();
            var pay = await LocalDb.GetPayments();
            var s = await LocalDb.GetServices();

            _pendingCount = c.Count(x => x.SyncState != SyncState.Synced) +
                            p.Count(x => x.SyncState != SyncState.Synced) +
                            a.Count(x => x.SyncState != SyncState.Synced) +
                            pay.Count(x => x.SyncState != SyncState.Synced) +
                            s.Count(x => x.SyncState != SyncState.Synced);
        }
        catch (Exception ex)
        {
            _errors.Add($"Error loading pending count: {ex.Message}");
            Console.WriteLine(ex);
        }
    }

    private void BeginSignIn()
    {
        Navigation.NavigateTo("authentication/login");
    }

    private void BeginSignOut(MouseEventArgs args)
    {
        Navigation.NavigateToLogout("authentication/logout");
    }

    private async Task SyncData()
    {
        _isSyncing = true;
        _errors.Clear();
        try
        {
            await SyncService.SyncData();
            await LoadPendingCount();
        }
        catch (Exception ex)
        {
            _errors.Add(ex.Message);
            Console.WriteLine(ex);
        }
        finally
        {
            _isSyncing = false;
        }
    }
}
