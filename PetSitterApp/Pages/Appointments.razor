@page "/"
@page "/appointments"
@inject LocalDbService LocalDb
@inject IDialogService DialogService
@inject SyncService SyncService
@using PetSitterApp.Models

<MudStack Row="true" Class="mb-4">
    <MudText Typo="Typo.h5">Appointments</MudText>
    <MudSpacer />
    <MudSwitch @bind-Value="_showOnlyFutureOrUnpaid" Label="Future or Unpaid Only" Color="Color.Primary" />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddAppointmentDialog">Add Appointment</MudButton>
</MudStack>

<MudTextField @bind-Value="_searchString" Placeholder="Search by name" Adornment="Adornment.Start" Immediate="true" AdornmentIcon="@Icons.Material.Filled.Search" Class="mb-4" />

<MudDataGrid Items="@FilteredAppointments" Filterable="true" Sortable="true" RowsPerPage="10" FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive" QuickFilter="@_quickFilter">
    <Columns>
        <PropertyColumn Property="x => x.Start" Title="Start" Format="d" />
        <PropertyColumn Property="x => x.End" Title="End" Format="d" />
        <PropertyColumn Property="x => x.ServiceType" Title="Service" />
        <TemplateColumn Title="Customer">
            <CellTemplate>
                <MudLink OnClick="@(() => OpenContactDialog(context.Item.CustomerId))" Underline="Underline.Always">
                    @GetCustomerName(context.Item.CustomerId)
                </MudLink>
            </CellTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x => x.ExpectedAmount" Title="Expected" Format="C" />
        <TemplateColumn Title="Balance">
             <CellTemplate>
                 @GetBalance(context.Item).ToString("C")
             </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Notes">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Note"
                               Color="Color.Primary"
                               Disabled="@(!HasNotes(context.Item))"
                               OnClick="@(() => OpenNotesDialog(context.Item))" />
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Actions">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditAppointmentDialog(context.Item))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteAppointment(context.Item))" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="Appointment" />
    </PagerContent>
</MudDataGrid>

@code {
    private List<Appointment> AppointmentList = new();
    private List<Customer> CustomerList = new();
    private Dictionary<Guid, Customer> _customerDict = new();
    private Dictionary<Guid, decimal> _appointmentBalances = new();
    private List<Pet> AllPets = new();
    private Dictionary<Guid, Pet> _petDict = new();
    private bool _showOnlyFutureOrUnpaid = true;
    private string _searchString = string.Empty;

    private Func<Appointment, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (GetCustomerName(x.CustomerId).Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    private IEnumerable<Appointment> FilteredAppointments => _showOnlyFutureOrUnpaid
        ? AppointmentList.Where(a => (a.End >= DateTime.Today) || GetBalance(a) > 0)
        : AppointmentList;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        AppointmentList = (await LocalDb.GetAppointments()).Where(a => !a.IsDeleted).ToList();
        CustomerList = await LocalDb.GetCustomers();
        _customerDict = CustomerList.ToDictionary(c => c.Id);
        var payments = await LocalDb.GetPayments();
        _appointmentBalances = payments
            .GroupBy(p => p.AppointmentId)
            .ToDictionary(g => g.Key, g => g.Sum(p => p.Amount));
        AllPets = await LocalDb.GetPets();
        _petDict = AllPets.ToDictionary(p => p.Id);
        StateHasChanged();
    }

    private bool HasNotes(Appointment appt)
    {
        if (!string.IsNullOrWhiteSpace(appt.Description)) return true;

        if (_customerDict.TryGetValue(appt.CustomerId, out var customer) && !string.IsNullOrWhiteSpace(customer.Notes)) return true;

        // Pets
        foreach (var petId in appt.PetIds)
        {
            if (_petDict.TryGetValue(petId, out var pet) && !string.IsNullOrWhiteSpace(pet.Notes))
                return true;
        }
        return false;
    }

    private void OpenNotesDialog(Appointment appt)
    {
        if (!_customerDict.TryGetValue(appt.CustomerId, out var customer)) customer = new Customer();
        var pets = AllPets.Where(p => appt.PetIds.Contains(p.Id)).ToList();

        var parameters = new DialogParameters { ["Appointment"] = appt, ["Customer"] = customer, ["Pets"] = pets };
        DialogService.Show<AppointmentNotesDialog>("Notes", parameters);
    }

    private void OpenContactDialog(Guid customerId)
    {
        if (_customerDict.TryGetValue(customerId, out var customer))
        {
            var pets = AllPets.Where(p => p.CustomerId == customer.Id).ToList();
            var parameters = new DialogParameters { ["Customer"] = customer, ["Pets"] = pets };
            DialogService.Show<CustomerContactDialog>(customer.FullName, parameters);
        }
    }

    private string GetCustomerName(Guid customerId)
    {
        return _customerDict.TryGetValue(customerId, out var customer) ? customer.FullName : "Unknown";
    }

    private decimal GetBalance(Appointment appt)
    {
        var paid = _appointmentBalances.TryGetValue(appt.Id, out var amount) ? amount : 0;
        return appt.ExpectedAmount - paid;
    }

    private async Task OpenAddAppointmentDialog()
    {
        var parameters = new DialogParameters { ["Appointment"] = new Appointment { Start = DateTime.Now, End = DateTime.Now.AddHours(1) } };
        var dialog = DialogService.Show<AppointmentDialog>("Add Appointment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            _ = Task.Run(async () => { await Task.Delay(1000); await SyncService.TryAutoSync(); });
        }
    }

    private async Task OpenEditAppointmentDialog(Appointment appointment)
    {
        var parameters = new DialogParameters { ["Appointment"] = appointment };
        var dialog = DialogService.Show<AppointmentDialog>("Edit Appointment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            _ = Task.Run(async () => { await Task.Delay(1000); await SyncService.TryAutoSync(); });
        }
    }

    private async Task DeleteAppointment(Appointment appointment)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Appointment",
            "Are you sure you want to delete this appointment?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            appointment.IsDeleted = true;
            appointment.UpdatedAt = DateTime.UtcNow;
            appointment.SyncState = SyncState.PendingUpdate;
            await LocalDb.SaveAppointment(appointment);
            await LoadData();
            _ = Task.Run(async () => { await Task.Delay(1000); await SyncService.TryAutoSync(); });
        }
    }
}
