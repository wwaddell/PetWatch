@page "/"
@page "/appointments"
@inject LocalDbService LocalDb
@inject IDialogService DialogService
@inject SyncService SyncService
@using PetSitterApp.Models

<MudStack Row="true" Class="mb-4">
    <MudText Typo="Typo.h5">Appointments</MudText>
    <MudSpacer />
    <MudSwitch @bind-Value="_showOnlyFutureOrUnpaid" Label="Future or Unpaid Only" Color="Color.Primary" />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddAppointmentDialog">Add Appointment</MudButton>
</MudStack>

<MudDataGrid Items="@FilteredAppointments" Filterable="true" Sortable="true" RowsPerPage="10">
    <Columns>
        <PropertyColumn Property="x => x.Start" Title="Start" Format="d" />
        <PropertyColumn Property="x => x.End" Title="End" Format="d" />
        <PropertyColumn Property="x => x.ServiceType" Title="Service" />
        <TemplateColumn Title="Customer">
            <CellTemplate>
                <MudLink OnClick="@(() => OpenContactDialog(context.Item.CustomerId))" Underline="Underline.Always">
                    @GetCustomerName(context.Item.CustomerId)
                </MudLink>
            </CellTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x => x.ExpectedAmount" Title="Expected" Format="C" />
        <TemplateColumn Title="Balance">
             <CellTemplate>
                 @GetBalance(context.Item).ToString("C")
             </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Notes">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Note"
                               Color="Color.Primary"
                               Disabled="@(!HasNotes(context.Item))"
                               OnClick="@(() => OpenNotesDialog(context.Item))" />
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Actions">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditAppointmentDialog(context.Item))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteAppointment(context.Item))" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="Appointment" />
    </PagerContent>
</MudDataGrid>

@code {
    private List<Appointment> AppointmentList = new();
    private List<Customer> CustomerList = new();
    private List<Payment> PaymentList = new();
    private List<Pet> AllPets = new();
    private bool _showOnlyFutureOrUnpaid = true;

    private IEnumerable<Appointment> FilteredAppointments => _showOnlyFutureOrUnpaid
        ? AppointmentList.Where(a => (a.End >= DateTime.Today) || GetBalance(a) > 0)
        : AppointmentList;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        AppointmentList = await LocalDb.GetAppointments();
        CustomerList = await LocalDb.GetCustomers();
        PaymentList = await LocalDb.GetPayments();
        AllPets = await LocalDb.GetPets();
        StateHasChanged();
    }

    private bool HasNotes(Appointment appt)
    {
        if (!string.IsNullOrWhiteSpace(appt.Description)) return true;

        var customer = CustomerList.FirstOrDefault(c => c.Id == appt.CustomerId);
        if (customer != null && !string.IsNullOrWhiteSpace(customer.Notes)) return true;

        // Pets
        return AllPets.Any(p => appt.PetIds.Contains(p.Id) && !string.IsNullOrWhiteSpace(p.Notes));
    }

    private void OpenNotesDialog(Appointment appt)
    {
        var customer = CustomerList.FirstOrDefault(c => c.Id == appt.CustomerId) ?? new Customer();
        var pets = AllPets.Where(p => appt.PetIds.Contains(p.Id)).ToList();

        var parameters = new DialogParameters { ["Appointment"] = appt, ["Customer"] = customer, ["Pets"] = pets };
        DialogService.Show<AppointmentNotesDialog>("Notes", parameters);
    }

    private void OpenContactDialog(Guid customerId)
    {
        var customer = CustomerList.FirstOrDefault(c => c.Id == customerId);
        if (customer != null)
        {
            var parameters = new DialogParameters { ["Customer"] = customer };
            DialogService.Show<CustomerContactDialog>("Contact", parameters);
        }
    }

    private string GetCustomerName(Guid customerId)
    {
        var customer = CustomerList.FirstOrDefault(c => c.Id == customerId);
        return customer?.FullName ?? "Unknown";
    }

    private decimal GetBalance(Appointment appt)
    {
        var paid = PaymentList.Where(p => p.AppointmentId == appt.Id).Sum(p => p.Amount);
        return appt.ExpectedAmount - paid;
    }

    private async Task OpenAddAppointmentDialog()
    {
        var parameters = new DialogParameters { ["Appointment"] = new Appointment { Start = DateTime.Now, End = DateTime.Now.AddHours(1) } };
        var dialog = DialogService.Show<AppointmentDialog>("Add Appointment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            _ = SyncService.TryAutoSync();
        }
    }

    private async Task OpenEditAppointmentDialog(Appointment appointment)
    {
        var parameters = new DialogParameters { ["Appointment"] = appointment };
        var dialog = DialogService.Show<AppointmentDialog>("Edit Appointment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            _ = SyncService.TryAutoSync();
        }
    }

    private async Task DeleteAppointment(Appointment appointment)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Appointment",
            "Are you sure you want to delete this appointment?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            await LocalDb.DeleteAppointment(appointment.Id);
            await LoadData();
            _ = SyncService.TryAutoSync();
        }
    }
}
