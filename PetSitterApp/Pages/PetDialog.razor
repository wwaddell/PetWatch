@using PetSitterApp.Models
@inject LocalDbService LocalDb

<MudDialog>
    <DialogContent>
        @if (!string.IsNullOrEmpty(_ownerName))
        {
            <MudText Typo="Typo.subtitle1" Class="mb-2">Owner: <b>@_ownerName</b></MudText>
        }

        <MudTextField @bind-Value="_workingPet.Name" Label="Name" Required="true" />

        <MudSelect T="string" Label="Species" @bind-Value="_selectedSpecies">
             @foreach(var s in _speciesList)
             {
                 <MudSelectItem Value="@s">@s</MudSelectItem>
             }
        </MudSelect>

        @if (_selectedSpecies == "Other")
        {
             <MudTextField @bind-Value="_workingPet.Species" Label="Specify Species" Required="true" />
        }

        <MudTextField @bind-Value="_workingPet.Breed" Label="Breed" />

        <MudDatePicker Label="Date of Birth" @bind-Date="_workingPet.DateOfBirth" Clearable="true" PickerVariant="PickerVariant.Dialog" />
        <MudDatePicker Label="Date of Death" @bind-Date="_workingPet.DateOfDeath" HelperText="Leave empty if alive" Clearable="true" PickerVariant="PickerVariant.Dialog" />

        <MudTextField @bind-Value="_workingPet.Notes" Label="Notes" Lines="2" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Pet Pet { get; set; } = new();

    private Pet _workingPet = new();
    private string _selectedSpecies = "Dog";
    private List<string> _speciesList = new() { "Dog", "Cat", "Bird", "Fish", "Reptile", "Plant", "Other" };
    private string _ownerName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Clone for editing
        _workingPet = Pet.Clone();

        if (Pet.CustomerId != Guid.Empty)
        {
            var customers = await LocalDb.GetCustomers();
            var owner = customers.FirstOrDefault(c => c.Id == Pet.CustomerId);
            if (owner != null)
            {
                _ownerName = owner.FullName;
            }
        }

        if (!string.IsNullOrEmpty(_workingPet.Species))
        {
            if (_speciesList.Contains(_workingPet.Species))
            {
                _selectedSpecies = _workingPet.Species;
            }
            else
            {
                _selectedSpecies = "Other";
            }
        }
    }

    private void Submit()
    {
        if (_selectedSpecies != "Other")
        {
            _workingPet.Species = _selectedSpecies;
        }

        // Copy back to original
        Pet.CopyFrom(_workingPet);

        MudDialog.Close(DialogResult.Ok(Pet));
    }

    private void Cancel() => MudDialog.Cancel();
}
