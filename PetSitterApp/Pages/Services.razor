@page "/services"
@inject LocalDbService LocalDb
@inject IDialogService DialogService
@inject SyncService SyncService
@using PetSitterApp.Models

<MudTable Items="@ServiceList" Hover="true" Breakpoint="Breakpoint.Sm">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Services</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenAddServiceDialog">Add Service</MudButton>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Default Rate</MudTh>
        <MudTh>Multi/Day</MudTh>
        <MudTh>Obsolete</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Rate">@context.DefaultRate.ToString("C")</MudTd>
        <MudTd DataLabel="Multi/Day">
            <MudCheckBox Value="@context.IsMultiplePerDay" ReadOnly="true" Color="Color.Primary" />
        </MudTd>
        <MudTd DataLabel="Obsolete">
            <MudCheckBox Value="@context.IsObsolete" ReadOnly="true" Color="Color.Secondary" />
        </MudTd>
        <MudTd DataLabel="Actions">
            <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditServiceDialog(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteService(context))" />
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<ServiceModel> ServiceList = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadServices();
    }

    private async Task LoadServices()
    {
        ServiceList = await LocalDb.GetServices();
        StateHasChanged();
    }

    private async Task OpenAddServiceDialog()
    {
        var parameters = new DialogParameters { ["Service"] = new ServiceModel() };
        var dialog = DialogService.Show<ServiceDialog>("Add Service", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ServiceModel service)
        {
            service.SyncState = SyncState.PendingCreate;
            service.UpdatedAt = DateTime.UtcNow;
            await LocalDb.SaveService(service);
            await SyncService.TryAutoSync();
            await LoadServices();
            _ = SyncService.TryAutoSync();
        }
    }

    private async Task OpenEditServiceDialog(ServiceModel service)
    {
        // Clone to avoid editing directly in list before save?
        // Or just edit and save. For simple app, edit directly is common but passing ref means live update in background?
        // DialogService passes object by reference.

        var parameters = new DialogParameters { ["Service"] = service };
        var dialog = DialogService.Show<ServiceDialog>("Edit Service", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ServiceModel updatedService)
        {
            updatedService.SyncState = SyncState.PendingUpdate;
            updatedService.UpdatedAt = DateTime.UtcNow;
            await LocalDb.SaveService(updatedService);
            await SyncService.TryAutoSync();
            await LoadServices();
            _ = SyncService.TryAutoSync();
        }
    }

    private async Task DeleteService(ServiceModel service)
    {
        await LocalDb.DeleteService(service.Id);
        await SyncService.TryAutoSync();
        await LoadServices();
        _ = SyncService.TryAutoSync();
    }
}
