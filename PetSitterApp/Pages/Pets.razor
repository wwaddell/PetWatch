@page "/pets"
@inject LocalDbService LocalDb
@inject IDialogService DialogService
@inject SyncService SyncService
@using PetSitterApp.Models

<div style="position: sticky; top: var(--mud-appbar-height, 64px); z-index: 5; background-color: var(--mud-palette-background); padding-bottom: 10px;">
    <MudStack Row="true" Class="mb-4">
        <MudText Typo="Typo.h5">Pets</MudText>
        <MudSpacer />
    </MudStack>

    <MudTextField @bind-Value="_searchString" Placeholder="Search by pet or customer name" Adornment="Adornment.Start" Immediate="true" AdornmentIcon="@Icons.Material.Filled.Search" Class="mb-4" />
</div>

<MudDataGrid Items="@_petList" Filterable="true" Sortable="true" RowsPerPage="10" FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive" QuickFilter="@_quickFilter">
    <Columns>
        <PropertyColumn Property="x => x.Name" Title="Name" InitialDirection="SortDirection.Ascending" />
        <PropertyColumn Property="x => x.Species" Title="Species" />
        <PropertyColumn Property="x => x.Breed" Title="Breed" />
        <TemplateColumn Title="Customer">
            <CellTemplate>
                @GetCustomerName(context.Item.CustomerId)
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Notes">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Note"
                               Color="Color.Primary"
                               Disabled="@(!HasNotes(context.Item))"
                               OnClick="@(() => OpenNotesDialog(context.Item))" />
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Actions">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.AddTask" OnClick="@(() => OpenAddAppointmentDialog(context.Item))" />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditPetDialog(context.Item))" />
                 @if (IsBirthdayApproaching(context.Item, out var age, out var bdayDate, out var daysAway))
                 {
                     <MudIconButton Icon="@Icons.Material.Filled.Celebration" Color="Color.Secondary"
                                    OnClick="@(() => OpenBirthdayDialog(context.Item, age, bdayDate, daysAway))"
                                    Title="Birthday approaching!" />
                 }
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="Pet" />
    </PagerContent>
</MudDataGrid>

@code {
    private List<Pet> _petList = new();
    private List<Customer> _customerList = new();
    private Dictionary<Guid, string> _customerNames = new();
    private string _searchString = string.Empty;

    private Func<Pet, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        var custName = GetCustomerName(x.CustomerId);
        if (custName.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _petList = (await LocalDb.GetPets()).Where(p => !string.IsNullOrEmpty(p.Name)).ToList();
        _customerList = await LocalDb.GetCustomers();
        _customerNames = _customerList.ToDictionary(c => c.Id, c => c.FullName);
    }

    private string GetCustomerName(Guid customerId)
    {
        return _customerNames.TryGetValue(customerId, out var name) ? name : "Unknown";
    }

    private bool HasNotes(Pet pet)
    {
        return !string.IsNullOrWhiteSpace(pet.Notes);
    }

    private void OpenNotesDialog(Pet pet)
    {
        var parameters = new DialogParameters
        {
            ["Customer"] = new Customer(), // Dummy customer to skip customer notes section
            ["Pets"] = new List<Pet> { pet }
        };
        DialogService.Show<NotesDialog>("Notes", parameters);
    }

    private (DateTime Date, int Age) GetClosestBirthday(Pet pet)
    {
        if (!pet.DateOfBirth.HasValue) return (DateTime.MinValue, 0);

        var today = DateTime.Today;
        var dob = pet.DateOfBirth.Value;

        var baseYearDiff = today.Year - dob.Year;

        var candidates = new List<(DateTime Date, int Age)>();

        // Previous year
        candidates.Add((dob.AddYears(baseYearDiff - 1), baseYearDiff - 1));

        // Current year
        candidates.Add((dob.AddYears(baseYearDiff), baseYearDiff));

        // Next year
        candidates.Add((dob.AddYears(baseYearDiff + 1), baseYearDiff + 1));

        return candidates.MinBy(x => Math.Abs((x.Date - today).TotalDays));
    }

    private bool IsBirthdayApproaching(Pet pet, out int age, out DateTime bdayDate, out int daysAway)
    {
        age = 0;
        bdayDate = DateTime.MinValue;
        daysAway = 0;

        if (!pet.DateOfBirth.HasValue) return false;

        var closest = GetClosestBirthday(pet);
        bdayDate = closest.Date;
        age = closest.Age;
        daysAway = (int)(bdayDate - DateTime.Today).TotalDays;

        return Math.Abs(daysAway) <= 10;
    }

    private void OpenBirthdayDialog(Pet pet, int age, DateTime birthday, int daysAway)
    {
        var parameters = new DialogParameters
        {
            ["PetName"] = pet.Name,
            ["Age"] = age,
            ["Birthday"] = birthday,
            ["DaysAway"] = daysAway
        };
        DialogService.Show<BirthdayDialog>("Birthday Details", parameters);
    }

    private async Task OpenEditPetDialog(Pet pet)
    {
        var parameters = new DialogParameters { ["Pet"] = pet };
        var dialog = DialogService.Show<PetDialog>("Edit Pet", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is Pet updatedPet)
        {
            updatedPet.UpdatedAt = DateTime.UtcNow;
            updatedPet.SyncState = SyncState.PendingUpdate;
            await LocalDb.SavePet(updatedPet);
            await LoadData();
            _ = Task.Run(async () => { await Task.Delay(1000); await SyncService.TryAutoSync(); });
        }
    }

    private async Task OpenAddAppointmentDialog(Pet pet)
    {
        var parameters = new DialogParameters { ["Appointment"] = new Appointment { CustomerId = pet.CustomerId, PetIds = new List<Guid> { pet.Id }, Start = DateTime.Now, End = DateTime.Now.AddHours(1) } };
        var dialog = DialogService.Show<AppointmentDialog>("Add Appointment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadData();
            _ = Task.Run(async () => { await Task.Delay(1000); await SyncService.TryAutoSync(); });
        }
    }
}
